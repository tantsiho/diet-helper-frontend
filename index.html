<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飲食決策教練 | Diet Decision Helper</title>
    <!-- 引入 Tailwind CSS 框架，用於快速美化網頁介面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8 bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- 主容器，用於放置應用程式和 Threads 區塊 -->
    <!-- 使用 flexbox 佈局，在桌面端左右並排，行動端上下堆疊 -->
    <div class="flex flex-col lg:flex-row w-full max-w-7xl gap-6">

        <!-- 左側主應用程式區塊 -->
        <main class="flex-1 bg-white p-6 sm:p-8 rounded-2xl shadow-xl transition-all duration-300">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-2">飲食決策教練</h1>
            <h2 class="text-xl sm:text-2xl font-semibold text-center text-gray-600 mb-6">Diet Decision Helper</h2>
            <p class="text-center text-gray-600 mb-8">
                <span class="font-bold text-red-500">教練在此！</span> 點擊按鈕，給我一個你吃東西的理由！
                <br class="hidden sm:block">
                (Coach here! Click the button and give me a reason for your laziness!)
            </p>

            <div class="flex flex-col sm:flex-row gap-4 mb-8">
                <button id="hungryBtn" class="w-full px-6 py-4 bg-red-600 text-white font-semibold rounded-xl shadow-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-200 ease-in-out transform hover:scale-105">
                    我餓了！(I'm hungry!)
                </button>
                <button id="notHungryBtn" class="w-full px-6 py-4 bg-red-500 text-white font-semibold rounded-xl shadow-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-200 ease-in-out transform hover:scale-105">
                    我不餓！(I'm not hungry!)
                </button>
            </div>

            <div id="resultContainer" class="mt-8 p-6 bg-red-50 rounded-xl border-2 border-red-200 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-3">教練的建議： (Coach's Recommendation)</h3>
                <div id="recommendation" class="text-gray-700 mt-2 prose max-w-none"></div>
            </div>

            <div id="loadingIndicator" class="mt-8 text-center hidden">
                <svg class="animate-spin h-8 w-8 text-red-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-500">教練正在給你安排課表... (Coach is arranging your schedule...)</p>
            </div>
        </main>

        <!-- 新增的右側 Threads 貼文區塊 -->
        <aside class="w-full lg:w-80 bg-white rounded-xl shadow-lg p-6 flex flex-col items-center">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">贊助廣告</h2>
            <!-- 這是 Threads 官方推薦的動態嵌入碼。
                 它只包含一個 blockquote 和一個超連結，
                 Threads 的外部腳本會自動將它渲染成完整的貼文，
                 並能更好地適應容器大小。 -->
            <blockquote class="threads-thread">
                <a href="https://www.threads.net/@melocore/post/DLjRfpYTlV4">
                </a>
            </blockquote>
        </aside>

    </div>
    
    <!-- 自定義訊息框 -->
    <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm text-center">
            <p id="messageText" class="text-lg font-semibold text-gray-800"></p>
            <button id="closeMessageBtn" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">確定</button>
        </div>
    </div>

    <script>
        // Function to show a custom message box
        function showMessage(text) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        document.getElementById('closeMessageBtn').addEventListener('click', function() {
            document.getElementById('messageBox').classList.add('hidden');
        });

        // 幫按鈕加上防抖函式
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Function to handle the API call
        async function getRecommendation(isHungry) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultContainer = document.getElementById('resultContainer');
            const recommendationEl = document.getElementById('recommendation');
            const hungryBtn = document.getElementById('hungryBtn');
            const notHungryBtn = document.getElementById('notHungryBtn');

            // Hide result, show loading spinner, and disable buttons
            resultContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            hungryBtn.disabled = true;
            notHungryBtn.disabled = true;

            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const hungerState = isHungry ? '是' : '否';

            try {
                // *** 重要：請將此處的佔位符網址替換為你實際的 Render 服務網址 ***
                // *** IMPORTANT: Please replace this placeholder URL with your actual Render service URL ***
                const backendApiUrl = "https://diet-decision-backend.onrender.com/get-recommendation";

                const response = await fetch(backendApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentTime, isHungry: hungerState })
                });

                if (!response.ok) {
                    throw new Error('教練的回應出錯了！你的網路線是不是斷了？');
                }

                const result = await response.json();
                
                if (result.text) {
                    recommendationEl.innerHTML = marked.parse(result.text);
                } else {
                    throw new Error('教練的回應結構不正確！可能是他去喝水了。');
                }
            } catch (error) {
                console.error('API 呼叫失敗:', error);
                showMessage('教練的大聲公好像壞了，請稍後再試。');
                recommendationEl.innerHTML = '<p>教練不在線上，請檢查你的網路線或休息一下。</p>';
            } finally {
                // Hide loading spinner and enable button whether successful or not
                loadingIndicator.classList.add('hidden');
                hungryBtn.disabled = false;
                notHungryBtn.disabled = false;
                resultContainer.classList.remove('hidden');
            }
        }

        // Event listeners for the buttons
        // 使用防抖函式來包裝 API 呼叫
        const debouncedGetRecommendation = debounce(getRecommendation, 500);

        document.getElementById('hungryBtn').addEventListener('click', () => debouncedGetRecommendation(true));
        document.getElementById('notHungryBtn').addEventListener('click', () => debouncedGetRecommendation(false));
    </script>
    <!-- Load marked.js to support Markdown formatting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Threads 貼文的外部嵌入腳本，這是動態顯示貼文的關鍵 -->
    <script async src="https://www.threads.net/embeds.js"></script>
</body>
</html>
