<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飲食決策助手 | Diet Decision Helper</title>
    <!-- 引入 Tailwind CSS 實現現代化且乾淨的設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8 bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl max-w-lg w-full transition-all duration-300">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-2">飲食決策助手</h1>
        <h2 class="text-xl sm:text-2xl font-semibold text-center text-gray-600 mb-6">Diet Decision Helper</h2>
        <p class="text-center text-gray-600 mb-8">
            <span class="font-bold text-red-500">教練在此！</span> 點擊按鈕，給我一個你偷懶的理由！
            <br class="hidden sm:block">
            (Coach here! Click the button and give me a reason for your laziness!)
        </p>

        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <button id="hungryBtn" class="w-full px-6 py-4 bg-red-600 text-white font-semibold rounded-xl shadow-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-200 ease-in-out transform hover:scale-105">
                我餓了！(I'm hungry!)
            </button>
            <button id="notHungryBtn" class="w-full px-6 py-4 bg-red-500 text-white font-semibold rounded-xl shadow-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-200 ease-in-out transform hover:scale-105">
                我不餓！(I'm not hungry!)
            </button>
        </div>

        <div id="resultContainer" class="mt-8 p-6 bg-red-50 rounded-xl border-2 border-red-200 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-3">教練的建議： (Coach's Recommendation)</h3>
            <div id="recommendation" class="text-gray-700 mt-2 prose max-w-none"></div>
        </div>

        <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm text-center">
                <p id="messageText" class="text-lg font-semibold text-gray-800"></p>
                <button id="closeMessageBtn" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">確定</button>
            </div>
        </div>

        <div id="loadingIndicator" class="mt-8 text-center hidden">
            <svg class="animate-spin h-8 w-8 text-red-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gray-500">教練正在給你安排課表... (Coach is arranging your schedule...)</p>
        </div>
    </div>

    <script>
        // 用於顯示自訂訊息框的函式
        function showMessage(text) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        document.getElementById('closeMessageBtn').addEventListener('click', function() {
            document.getElementById('messageBox').classList.add('hidden');
        });

        // 處理 API 呼叫的函式
        async function getRecommendation(isHungry) {
            // Log for traffic observation: A button has been clicked.
            console.log('--- 飲食決策助手: 開始處理請求 ---');

            // IMPORTANT: 將這裡的 URL 替換成您在 Render 或 Vercel 部署後的網址！
            // IMPORTANT: Replace this URL with the actual URL of your backend service on Render or Vercel!
            const backendUrl = "YOUR_BACKEND_URL";

            if (backendUrl === "YOUR_BACKEND_URL") {
                showMessage("教練說：你沒有給我後端網址，怎麼訓練？請先在程式碼中填入網址！");
                console.error("錯誤: backendUrl 尚未設定!"); // Log the error to the console
                return;
            }

            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultContainer = document.getElementById('resultContainer');
            const recommendationEl = document.getElementById('recommendation');
            const hungryBtn = document.getElementById('hungryBtn');
            const notHungryBtn = document.getElementById('notHungryBtn');

            resultContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            hungryBtn.disabled = true;
            notHungryBtn.disabled = true;

            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const hungerState = isHungry ? '是' : '否';

            // 記錄要發送到後端的資料
            console.log(`按鈕點擊狀態: isHungry=${isHungry}`);
            console.log(`傳送至後端的資料: { currentTime: '${currentTime}', isHungry: '${hungerState}' }`);

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentTime, isHungry: hungerState })
                });

                // 記錄後端的回應狀態
                console.log(`後端回應狀態: ${response.status}`);

                if (!response.ok) {
                    throw new Error('教練的回應出錯了！你的網路線是不是斷了？');
                }

                const result = await response.json();
                
                // 記錄從後端接收到的結果
                console.log('從後端接收到的結果:', result);

                if (result.text) {
                    recommendationEl.innerHTML = marked.parse(result.text);
                } else {
                    throw new Error('教練的回應結構不正確！可能是他去喝水了。');
                }
            } catch (error) {
                console.error('API 呼叫失敗:', error);
                showMessage('教練的麥克風好像壞了，請稍後再試。');
                recommendationEl.innerHTML = '<p>教練不在線上，請檢查你的網路線或休息一下。</p>';
            } finally {
                // 記錄請求處理結束
                console.log('--- 飲食決策助手: 請求處理結束 ---');
                loadingIndicator.classList.add('hidden');
                hungryBtn.disabled = false;
                notHungryBtn.disabled = false;
                resultContainer.classList.remove('hidden');
            }
        }

        document.getElementById('hungryBtn').addEventListener('click', () => getRecommendation(true));
        document.getElementById('notHungryBtn').addEventListener('click', () => getRecommendation(false));
    </script>
    <!-- 載入 marked.js 以支援 Markdown 格式 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</body>
</html>

