<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飲食決策教練 | Diet Decision Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body class="p-4 sm:p-8 bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="flex flex-col lg:flex-row w-full max-w-7xl gap-6">

        <!-- 主應用程式 -->
        <main class="flex-1 bg-white p-6 sm:p-8 rounded-2xl shadow-xl transition-all duration-300">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-2">飲食決策教練</h1>
            <h2 class="text-xl sm:text-2xl font-semibold text-center text-gray-600 mb-6">Diet Decision Helper</h2>
            <p class="text-center text-gray-600 mb-8">
                <span class="font-bold text-red-500">教練在此！</span> 點擊按鈕，給我一個你吃東西的理由！
                <br class="hidden sm:block">
                (Coach here! Click the button and give me a reason for your laziness!)
            </p>

            <div class="flex flex-col sm:flex-row gap-4 mb-8">
                <button id="hungryBtn" class="w-full px-6 py-4 bg-red-600 text-white font-semibold rounded-xl shadow-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-200 ease-in-out transform hover:scale-105">
                    我餓了！(I'm hungry!)
                </button>
                <button id="notHungryBtn" class="w-full px-6 py-4 bg-red-500 text-white font-semibold rounded-xl shadow-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-200 ease-in-out transform hover:scale-105">
                    我不餓！(I'm not hungry!)
                </button>
            </div>

            <div id="resultContainer" class="mt-8 p-6 bg-red-50 rounded-xl border-2 border-red-200 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-3">教練的建議： (Coach's Recommendation)</h3>
                <div id="recommendation" class="text-gray-700 mt-2 prose max-w-none"></div>
            </div>

            <div id="loadingIndicator" class="mt-8 text-center hidden">
                <svg class="animate-spin h-8 w-8 text-red-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-500">教練正在給你安排課表... (Coach is arranging your schedule...)</p>
            </div>
        </main>

        <!-- 側欄：Threads 內嵌 -->
        <aside class="w-full lg:w-80 bg-white rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
            <h2 class="text-xl font-bold text-gray-800 mb-4">贊助廣告</h2>

            <blockquote class="text-post-media"
                data-text-post-permalink="https://www.threads.net/@melocore/post/DLjRfpYTlV4"
                data-text-post-version="0" id="ig-tp-DLjRfpYTlV4"
                style="background:#FFF;border:1px solid #00000026;border-radius:16px;max-width:540px;margin:1px;min-width:270px;width:100%;">
                <a href="https://www.threads.net/@melocore/post/DLjRfpYTlV4" target="_blank"
                   style="background:#FFFFFF;line-height:0;padding:0;text-align:center;text-decoration:none;width:100%;
                          font-family:-apple-system,BlinkMacSystemFont,sans-serif;">
                    <div style="padding:40px;display:flex;flex-direction:column;align-items:center;">
                        <div style="display:block;height:32px;width:32px;padding-bottom:20px;">
                            <!-- SVG 保留 -->
                            <svg aria-label="Threads" height="32px" role="img" viewBox="0 0 192 192" width="32px" xmlns="http://www.w3.org/2000/svg">
                                <path d="M141.537 88.9883C140.71 ... 129.507Z"/>
                            </svg>
                        </div>
                        <div style="font-size:15px;line-height:21px;color:#000;font-weight:600;">在 Threads 查看</div>
                    </div>
                </a>
            </blockquote>
        </aside>

    </div>

    <!-- 自定義訊息框 -->
    <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm text-center">
            <p id="messageText" class="text-lg font-semibold text-gray-800"></p>
            <button id="closeMessageBtn" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">確定</button>
        </div>
    </div>

    <script>
        function showMessage(text) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }
        document.getElementById('closeMessageBtn').addEventListener('click', function() {
            document.getElementById('messageBox').classList.add('hidden');
        });

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 保險：避免雙送請求
        let inflight = false;

        async function getRecommendation(isHungry) {
            if (inflight) return;
            inflight = true;

            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultContainer = document.getElementById('resultContainer');
            const recommendationEl = document.getElementById('recommendation');
            const hungryBtn = document.getElementById('hungryBtn');
            const notHungryBtn = document.getElementById('notHungryBtn');

            resultContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            hungryBtn.disabled = true;
            notHungryBtn.disabled = true;

            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            // ✅ 改傳布林值
            const hungerState = !!isHungry;

            try {
                // ✅ 改呼叫根路徑 '/'
                const backendApiUrl = "https://diet-decision-backend.onrender.com/";
                const response = await fetch(backendApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentTime, isHungry: hungerState })
                });
                if (!response.ok) throw new Error('教練的回應出錯了！');
                const result = await response.json();
                if (result.text) {
                    recommendationEl.innerHTML = marked.parse(result.text);
                } else {
                    throw new Error('回應結構不正確！');
                }
            } catch (error) {
                console.error('API 呼叫失敗:', error);
                showMessage('教練的大聲公好像壞了，請稍後再試。');
                recommendationEl.innerHTML = '<p>教練不在線上。</p>';
            } finally {
                inflight = false;
                loadingIndicator.classList.add('hidden');
                hungryBtn.disabled = false;
                notHungryBtn.disabled = false;
                resultContainer.classList.remove('hidden');
            }
        }

        const debouncedGetRecommendation = debounce(getRecommendation, 300);
        document.getElementById('hungryBtn').addEventListener('click', () => debouncedGetRecommendation(true));
        document.getElementById('notHungryBtn').addEventListener('click', () => debouncedGetRecommendation(false));
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Threads 正確 embed 腳本 -->
    <script async src="https://www.threads.net/embed.js"></script>
</body>
</html>
